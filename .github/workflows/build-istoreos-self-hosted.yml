name: Build iStoreOS (Self-Hosted)

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    env:
      FORCE_UNSAFE_CONFIGURE: 1
      GOPROXY: https://goproxy.cn,https://goproxy.io,https://proxy.golang.com.cn,direct
      GOSUMDB: sum.golang.google.cn
      GO111MODULE: on

    steps:
      - name: Update iStoreOS repository
        id: update
        run: |
          cd /opt/make-lxc/istoreos
          REMOTE_DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          if [ "$CURRENT_BRANCH" != "$REMOTE_DEFAULT_BRANCH" ]; then
            echo "Remote default branch changed from $CURRENT_BRANCH to $REMOTE_DEFAULT_BRANCH"
            echo "branch_changed=true" >> $GITHUB_OUTPUT
            git fetch origin $REMOTE_DEFAULT_BRANCH --depth=1
            git checkout $REMOTE_DEFAULT_BRANCH
            git branch --set-upstream-to=origin/$REMOTE_DEFAULT_BRANCH
          else
            echo "branch_changed=false" >> $GITHUB_OUTPUT
            git pull --depth=1
          fi
          
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Updated repository, branch: $BRANCH_NAME"

      - name: Clean previous build artifacts
        run: |
          cd /opt/make-lxc/istoreos
          if [ "${{ steps.update.outputs.branch_changed }}" = "true" ]; then
            echo "Branch changed, performing complete clean..."
            make distclean
          else
            echo "Same branch, performing regular clean..."
            make clean
          fi
          ./scripts/feeds clean

      - name: Download config and feeds
        run: |
          cd /opt/make-lxc/istoreos
          wget -O .config https://fw0.koolcenter.com/iStoreOS/x86_64/config.seed
          wget -O feeds.conf https://fw0.koolcenter.com/iStoreOS/x86_64/feeds.conf

      - name: Enable TARGZ rootfs
        run: |
          cd /opt/make-lxc/istoreos
          sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
          grep -q "CONFIG_TARGET_ROOTFS_TARGZ" .config || echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config

      - name: Disable incompatible drivers
        run: |
          cd /opt/make-lxc/istoreos
          sed -i 's/CONFIG_PACKAGE_kmod-i40e=y/# CONFIG_PACKAGE_kmod-i40e is not set/' .config

      - name: Update and install feeds
        run: |
          cd /opt/make-lxc/istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure build
        run: |
          cd /opt/make-lxc/istoreos
          make defconfig

      - name: Check disk space
        run: |
          if [ $(df /opt/make-lxc/istoreos | awk 'NR==2 {print $4}') -lt 60000000 ]; then
            echo "Error: Not enough disk space to build iStoreOS."
            exit 1
          else
            echo "Sufficient disk space available."
          fi

      - name: Rebuild tools and toolchain
        run: |
          cd /opt/make-lxc/istoreos
          if [ "${{ steps.update.outputs.branch_changed }}" = "true" ]; then
            echo "Branch changed, rebuilding tools and toolchain..."
            make tools/install V=s -j$(nproc)
            make toolchain/install V=s -j$(nproc)
          else
            echo "Same branch, skipping tools and toolchain rebuild."
          fi

      - name: Build firmware
        id: build
        run: |
          cd /opt/make-lxc/istoreos
          make -j$(nproc) V=s

      - name: Check build result and prepare artifacts
        id: prepare
        run: |
          cd /opt/make-lxc/istoreos
          if [ -f bin/targets/x86/64/*-rootfs.tar.gz ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            ROOTFS_FILE=$(ls bin/targets/x86/64/*-rootfs.tar.gz | head -n 1)
            echo "rootfs_file=$ROOTFS_FILE" >> $GITHUB_OUTPUT
            echo "Build successful! Found: $ROOTFS_FILE"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "Build failed!"
            exit 1
          fi

      - name: Create Release
        if: steps.prepare.outputs.build_success == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.update.outputs.branch_name }}-${{ github.run_number }}
          release_name: ${{ steps.update.outputs.branch_name }}-build-${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            iStoreOS Build - Branch: ${{ steps.update.outputs.branch_name }}
            
            Build Date: ${{ github.event.head_commit.timestamp }}
            Build Number: ${{ github.run_number }}
            Commit: ${{ github.sha }}
            Runner: Self-Hosted

      - name: Upload Release Asset
        if: steps.prepare.outputs.build_success == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.prepare.outputs.rootfs_file }}
          asset_name: istoreos-x86-64-rootfs.tar.gz
          asset_content_type: application/gzip

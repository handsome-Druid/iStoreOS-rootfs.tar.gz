name: Build iStoreOS

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: quay.io/centos/centos:stream9
      options: --privileged
    
    steps:
      - name: Maximize build space
        run: |
          df -h
          echo "Available space check"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y --allowerasing \
            git \
            binutils \
            bzip2 \
            diffutils \
            findutils \
            flex \
            gawk \
            gcc \
            util-linux \
            grep \
            coreutils \
            glibc-devel \
            zlib-devel \
            make \
            perl \
            python3 \
            rsync \
            subversion \
            unzip \
            which \
            patch \
            wget \
            ncurses-devel \
            ncurses-libs \
            xz

      - name: Clone iStoreOS repository and get branch name
        id: clone
        run: |
          git clone https://github.com/istoreos/istoreos.git
          cd istoreos
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Default branch: $BRANCH_NAME"

      - name: Download config and feeds
        run: |
          cd istoreos
          wget -O .config https://fw0.koolcenter.com/iStoreOS/x86_64/config.seed
          wget -O feeds.conf https://fw0.koolcenter.com/iStoreOS/x86_64/feeds.conf
      - name: Enable TARGZ rootfs
        run: |
          cd istoreos
          sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config

          cat >> .config << 'EOF'
          CONFIG_TARGET_ROOTFS_TARGZ=y
          CONFIG_TARGET_ROOTFS_SQUASHFS=n
          CONFIG_TARGET_ROOTFS_EXT4FS=n
          CONFIG_TARGET_ROOTFS_INITRAMFS=n
          CONFIG_TARGET_IMAGES=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL=n
          CONFIG_KERNEL_DEBUG_INFO=n
          CONFIG_KERNEL_DEBUG_INFO_REDUCED=n
          CONFIG_KERNEL_DEBUG_INFO_BTF=n
          CONFIG_SDK=n
          CONFIG_IB=n
          CONFIG_TARGET_BUILD_PACKAGES=n
          CONFIG_STRIP_KERNEL_EXPORTS=y
          CONFIG_KERNEL_BUILD_DOMAIN=""
          CONFIG_KERNEL_BUILD_USER=""
          EOF

      - name: Update and install feeds
        run: |
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure build
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          make defconfig

      - name: Build firmware
        id: build
        continue-on-error: true
        run: |
          cd istoreos
          export FORCE_UNSAFE_CONFIGURE=1
          make -j$(nproc) V=s 2>&1 | tee build.log
          echo "build_status=$?" >> $GITHUB_OUTPUT

      - name: Check build result and prepare artifacts
        id: prepare
        run: |
          cd istoreos
          if [ -f bin/targets/x86/64/*-rootfs.tar.gz ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            ROOTFS_FILE=$(ls bin/targets/x86/64/*-rootfs.tar.gz)
            echo "rootfs_file=$ROOTFS_FILE" >> $GITHUB_OUTPUT
            echo "Build successful! Found: $ROOTFS_FILE"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "Build failed! Preserving build.log"
          fi

      - name: Upload build log on failure
        if: steps.prepare.outputs.build_success != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-log-failed
          path: istoreos/build.log
          retention-days: 30

      - name: Create Release
        if: steps.prepare.outputs.build_success == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.clone.outputs.branch_name }}-${{ github.run_number }}
          release_name: ${{ steps.clone.outputs.branch_name }}
          draft: false
          prerelease: false
          body: |
            iStoreOS Build - Branch: ${{ steps.clone.outputs.branch_name }}
            
            Build Date: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.sha }}

      - name: Upload Release Asset
        if: steps.prepare.outputs.build_success == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.prepare.outputs.rootfs_file }}
          asset_name: istoreos-x86-64-rootfs.tar.gz
          asset_content_type: application/gzip
